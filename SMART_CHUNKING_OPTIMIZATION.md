# AI分块服务智能化提示词优化

## 概述

本次优化将AI分块服务的提示词从简化版本升级为智能化版本，能够根据文档结构（标题、段落、章节等）进行更精确的分块，提高分块质量和语义完整性。

## 优化内容

### 1. 提示词升级

**优化前（简化版本）：**
```
请将以下文本分成3-5个块，每个块100-300字符。只返回JSON格式：

{
    "chunks": [
        {"content": "文本块内容"}
    ]
}

文本：{text}
```

**优化后（智能化版本）：**
```
你是一个专业的文档分块专家。请将以下文本按照语义完整性和文档结构进行智能分块。

分块要求：
1. 分块数量：根据文档长度和结构，生成3-8个块
2. 每个块长度：100-500字符（重要内容可以适当放宽）
3. 分块原则：
   - 保持语义完整性，不要切断句子或段落
   - 优先按章节、标题、主题、功能模块分块
   - 每个块应该是一个相对独立的信息单元
   - 避免在句子中间分块
   - 标题和其内容应该在同一块中
   - 保持逻辑顺序和层次结构

4. 分块策略：
   - 识别文档标题（如：第一章、第二章、功能模块等）
   - 识别小节标题（如：一、二、三、1.1、1.2等）
   - 识别段落和列表结构
   - 如果是技术文档，按功能模块分块
   - 如果是说明文档，按章节分块
   - 如果是问答文档，按问题分块
   - 保持逻辑顺序和层次结构

请严格按照以下JSON格式返回，不要添加任何其他内容：

{
    "chunks": [
        {
            "content": "完整的文本块内容",
            "type": "块类型（如：章节、功能、问题、段落等）",
            "summary": "该块的简要描述"
        }
    ]
}

待分块文本：
{text}
```

### 2. 返回格式优化

**新增字段：**
- `type`: 块类型，标识内容性质（章节、功能、问题、段落等）
- `summary`: 块摘要，简要描述该块的内容

**优化前：**
```json
{
    "chunks": [
        {"content": "文本块内容"}
    ]
}
```

**优化后：**
```json
{
    "chunks": [
        {
            "content": "完整的文本块内容",
            "type": "章节",
            "summary": "该块的简要描述"
        }
    ]
}
```

### 3. 解析逻辑优化

更新了 `_strategy_manual_parse` 方法，使其能够正确解析包含 `type` 和 `summary` 字段的chunk对象：

```python
# 更宽松的匹配模式，只要包含content字段即可
chunk_pattern = r'\{[^{}]*"content"[^{}]*\}'
```

### 4. 智能分块方法同步

更新了 `_smart_split_content` 方法，使其返回的chunk对象也包含 `type` 和 `summary` 字段，与AI分块保持一致。

## 测试结果

### 技术文档测试
- **分块数量**: 7个块
- **类型分布**: 章节(3), 功能(4)
- **质量评分**: 76.2/100
- **特点**: 能够识别章节标题、功能模块，保持语义完整性

### 问答文档测试
- **分块数量**: 4个块
- **类型分布**: 章节(1), 问题-解答(3)
- **质量评分**: 73.3/100
- **特点**: 能够按问题-答案对进行分块

### 说明文档测试
- **分块数量**: 5个块
- **类型分布**: 章节(4), 功能模块(1)
- **质量评分**: 73.3/100
- **特点**: 能够按安装步骤、使用说明等章节分块

## 优化效果

### 1. 分块质量提升
- **语义完整性**: 保持句子和段落的完整性
- **结构识别**: 能够识别标题、章节、列表等文档结构
- **类型标注**: 为每个块提供类型和摘要信息

### 2. 适应性增强
- **文档类型**: 支持技术文档、问答文档、说明文档等多种类型
- **结构复杂度**: 能够处理包含标题、章节、列表的复杂文档
- **长度灵活性**: 根据内容重要性调整块长度

### 3. 可维护性提升
- **标准化格式**: 统一的JSON返回格式
- **错误处理**: 完善的JSON解析和错误处理机制
- **向后兼容**: 保持与现有系统的兼容性

## 配置参数

相关配置参数在 `config.conf` 中：

```ini
[api]
# AI分块专用配置
ai_chunking_model = Qwen/Qwen2-7B-Instruct
ai_chunking_max_tokens = 2048
ai_chunking_timeout = 30
ai_chunking_max_retries = 3
ai_chunking_retry_delay = 2
ai_chunking_min_text_length = 10
ai_chunking_min_chunk_length = 5
ai_chunking_max_chunk_length = 1000
```

## 使用建议

1. **文档准备**: 确保文档结构清晰，包含适当的标题和段落
2. **长度控制**: 对于重要内容，可以适当放宽长度限制
3. **类型利用**: 利用返回的type和summary字段进行后续处理
4. **质量监控**: 定期检查分块质量，根据需要进行调整

## 总结

通过这次优化，AI分块服务实现了从简单分块到智能分块的升级，能够更好地理解文档结构，提供更高质量的分块结果。新的提示词和解析逻辑确保了系统的稳定性和可靠性，为后续的文档处理和知识管理提供了更好的基础。 