# 文本块删除功能说明

## 功能概述

在文本块查询界面新增了删除和多选功能，允许用户人工删除不需要的文本块和对应的向量数据。

## 新增功能

### 1. 前端界面功能

#### 多选功能
- **全选复选框**: 在表格头部添加全选复选框，可以一键选择/取消选择当前页面的所有文本块
- **单个选择**: 每行文本块都有独立的复选框，可以单独选择
- **选择状态显示**: 全选复选框支持三种状态：未选中、部分选中、全部选中

#### 删除功能
- **单个删除**: 每行文本块都有删除按钮，可以删除单个文本块
- **批量删除**: 选择多个文本块后，显示批量删除按钮，可以一次性删除多个文本块
- **删除确认**: 删除操作都有确认对话框，防止误操作

#### 界面优化
- **动态按钮显示**: 批量删除按钮只在有选中项时显示
- **选中数量显示**: 批量删除按钮显示选中的文本块数量
- **操作反馈**: 删除成功后显示成功提示并自动刷新列表

### 2. 后端API接口

#### 单个删除接口
```
DELETE /api/text_blocks/{block_id}
```
- 功能：删除指定ID的文本块
- 参数：block_id (文本块ID，从1开始)
- 返回：删除成功/失败状态

#### 批量删除接口
```
POST /api/text_blocks/batch_delete
```
- 功能：批量删除多个文本块
- 参数：{ "ids": [1, 2, 3, ...] } (文本块ID列表)
- 返回：删除成功/失败状态和删除数量

### 3. 向量存储功能

#### 新增方法
```python
def delete_text_blocks(self, indices: List[int]) -> bool:
    """删除指定索引的文本块"""
```

#### 功能特点
- **索引验证**: 验证删除索引的有效性
- **批量处理**: 支持一次性删除多个文本块
- **索引重建**: 删除后自动重建FAISS索引
- **数据同步**: 同步更新文档列表和向量数据

## 技术实现

### 1. 前端实现

#### JavaScript功能
- `toggleSelection(id)`: 切换单个选择状态
- `toggleSelectAll()`: 切换全选状态
- `updateSelectAllState()`: 更新全选复选框状态
- `updateBatchDeleteButton()`: 更新批量删除按钮状态
- `deleteBlock(id)`: 删除单个文本块
- `batchDelete()`: 批量删除文本块

#### 状态管理
- 使用 `Set` 数据结构存储选中的ID
- 页面切换时自动清空选择状态
- 搜索时自动清空选择状态

### 2. 后端实现

#### 路由处理
- 单个删除：验证ID有效性，调用向量存储删除方法
- 批量删除：验证ID列表，批量调用删除方法
- 错误处理：完善的异常处理和错误返回

#### 数据持久化
- 删除操作后自动保存向量存储
- 确保数据一致性

### 3. 向量存储实现

#### 删除逻辑
1. 验证索引范围
2. 按降序排序索引（避免删除时索引变化）
3. 重建文档列表和向量数组
4. 重置并重建FAISS索引

#### 性能优化
- 批量删除时一次性重建索引
- 避免频繁的索引操作

## 使用说明

### 1. 单个删除
1. 在文本块列表中点击要删除的文本块行的"删除"按钮
2. 在确认对话框中点击"确定删除"
3. 系统会删除该文本块并刷新列表

### 2. 批量删除
1. 使用复选框选择要删除的文本块
2. 点击"批量删除"按钮
3. 在确认对话框中点击"确定删除"
4. 系统会删除所有选中的文本块并刷新列表

### 3. 全选操作
1. 点击表格头部的全选复选框
2. 可以选择/取消选择当前页面的所有文本块
3. 部分选中状态会显示为半选状态

## 安全考虑

### 1. 权限控制
- 删除功能需要用户登录
- 遵循现有的权限控制机制

### 2. 操作确认
- 所有删除操作都有确认对话框
- 显示删除的文本块数量
- 明确提示操作不可恢复

### 3. 数据验证
- 验证删除的文本块ID有效性
- 防止越界访问
- 完善的错误处理

## 测试验证

### 测试脚本
运行 `test_text_block_delete.py` 进行功能测试：

```bash
python test_text_block_delete.py
```

### 测试内容
- 向量存储删除功能
- API删除接口
- 前端集成功能
- 完整删除流程

## 注意事项

1. **数据备份**: 删除操作不可恢复，建议定期备份向量存储文件
2. **性能影响**: 大量删除操作可能影响系统性能
3. **索引重建**: 删除操作会重建FAISS索引，大文件删除可能需要较长时间
4. **并发安全**: 删除操作期间避免其他修改操作

## 未来改进

1. **软删除**: 考虑实现软删除功能，支持数据恢复
2. **删除日志**: 记录删除操作日志，便于审计
3. **批量操作优化**: 优化大量数据的批量删除性能
4. **删除预览**: 删除前显示将要删除的内容预览 